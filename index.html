<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XC Ski Stopwatch</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
            touch-action: manipulation;
        }
        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0; 
            border-radius: 4px;
        }
        .btn-active:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-lg md:text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-stopwatch"></i> XC Ski Timer
            </h1>
            <div class="flex gap-2">
                <button onclick="requestRestart()" class="text-xs bg-orange-600 hover:bg-orange-700 px-3 py-2 rounded text-white transition font-bold shadow flex items-center gap-1">
                    <i class="fa-solid fa-rotate-left"></i> 再レース
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 max-w-6xl mx-auto w-full relative z-0">
        
        <!-- Setup Screen (Centered) -->
        <div id="setupScreen" class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 space-y-6">
            <div class="flex justify-between items-center border-b pb-2">
                <h2 class="text-xl font-bold text-slate-700">大会設定</h2>
                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">v5.3 (Race Name)</span>
            </div>

            <!-- Race Info Input -->
            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-4">
                <h3 class="text-sm font-bold text-slate-600"><i class="fa-solid fa-pen-to-square"></i> 大会情報（成績表用）</h3>
                
                <!-- 大会名 -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">大会名</label>
                    <input type="text" id="raceName" class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="例: 第○回 市民スキー大会">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">種目名 / クラス</label>
                        <input type="text" id="raceTitle" class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none" placeholder="例: 一般男子 5km フリー">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">開催日</label>
                        <input type="date" id="raceDate" class="w-full p-2 border border-slate-300 rounded focus:border-blue-500 outline-none">
                    </div>
                </div>
            </div>
            
            <!-- Mode Selection -->
            <div>
                <label class="block text-sm font-semibold text-slate-600 mb-2">スタート方式</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="cursor-pointer border-2 border-slate-200 rounded-lg p-4 hover:border-blue-500 has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition relative group" onclick="toggleIntervalSettings(false)">
                        <input type="radio" name="raceMode" value="mass" checked class="peer sr-only">
                        <div class="text-center">
                            <i class="fa-solid fa-users text-2xl mb-2 text-slate-400 peer-checked:text-blue-600"></i>
                            <div class="font-bold text-slate-700">一斉スタート</div>
                            <div class="text-xs text-slate-500 mt-1">全員同時計測開始<br>ゴール・ラップ時操作</div>
                        </div>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-blue-600 rounded-lg pointer-events-none"></div>
                    </label>

                    <label class="cursor-pointer border-2 border-slate-200 rounded-lg p-4 hover:border-blue-500 has-[:checked]:border-blue-600 has-[:checked]:bg-blue-50 transition relative" onclick="toggleIntervalSettings(true)">
                        <input type="radio" name="raceMode" value="interval" class="peer sr-only">
                        <div class="text-center">
                            <i class="fa-solid fa-person-skiing-nordic text-2xl mb-2 text-slate-400 peer-checked:text-blue-600"></i>
                            <div class="font-bold text-slate-700">個別スタート</div>
                            <div class="text-xs text-slate-500 mt-1">1人ずつスタート<br>自動スタート設定可</div>
                        </div>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-blue-600 rounded-lg pointer-events-none"></div>
                    </label>
                </div>

                <!-- Interval Settings (Hidden by default) -->
                <div id="intervalSettings" class="hidden mt-4 bg-blue-50 p-4 rounded-lg border border-blue-200 animate-fade-in-down">
                    <label class="block text-sm font-bold text-blue-800 mb-2">
                        <i class="fa-solid fa-clock"></i> 自動スタート間隔
                    </label>
                    <div class="flex items-center gap-4">
                        <div class="relative flex-grow">
                            <input type="number" id="intervalSeconds" min="0" value="30" class="w-full p-2 border border-blue-300 rounded focus:border-blue-500 outline-none text-slate-700 font-mono text-lg text-center" placeholder="秒数">
                            <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 text-sm font-bold">秒</span>
                        </div>
                        <div class="text-xs text-blue-600 flex-shrink-0">
                            ※「0」にすると手動モードになります<br>
                            ※1人目のスタートを基準にカウントダウン
                        </div>
                    </div>
                </div>
            </div>

            <!-- Athlete Input -->
            <div>
                <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-2 gap-2">
                    <label class="block text-sm font-semibold text-slate-600">
                        選手リスト (1行に1名)
                    </label>
                    
                    <!-- Quick Generator -->
                    <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                        <span class="text-xs font-bold text-slate-500 pl-2">人数指定:</span>
                        <input type="number" id="quickCountInput" class="w-16 p-1 text-center border border-slate-300 rounded text-sm" value="10" min="1" max="100">
                        <button onclick="requestListGeneration()" class="bg-white hover:bg-slate-200 text-slate-700 border border-slate-300 px-3 py-1 rounded text-xs font-bold transition">
                            リスト再作成
                        </button>
                    </div>
                </div>
                
                <div class="relative">
                    <textarea id="athleteInput" rows="10" 
                        class="w-full border border-slate-300 rounded-lg p-3 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" 
                        placeholder="1. 選手A&#10;2. 選手B&#10;3. 選手C..."
                        oninput="updateAthleteCount()"></textarea>
                    <span id="athleteCountBadge" class="absolute bottom-4 right-4 text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full shadow-sm opacity-90">
                        現在: 10名
                    </span>
                </div>
                <p class="text-xs text-slate-500 mt-1 text-right">※リストを直接編集して追加・削除も可能です</p>
            </div>

            <button onclick="startRaceSetup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 text-lg">
                レース画面へ移動 <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>

        <!-- Race Screen (2 Column Layout) -->
        <div id="raceScreen" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                
                <!-- Main Column: Timer List -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Mass Start Master Control -->
                    <div id="massStartControl" class="bg-white rounded-xl shadow-md p-4 hidden sticky top-20 z-40 border-l-4 border-green-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-slate-700 text-sm md:text-base">大会経過時間</h3>
                                <div id="masterClock" class="font-mono text-3xl md:text-4xl font-bold text-slate-800 tracking-tighter">00:00.00</div>
                            </div>
                            <button id="masterStartBtn" onclick="triggerMassStart()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 md:px-6 rounded-lg shadow-md transition transform active:scale-95 text-sm md:text-base whitespace-nowrap">
                                <i class="fa-solid fa-play"></i> 全員スタート
                            </button>
                        </div>
                    </div>

                    <!-- Interval Start Info -->
                    <div id="intervalInfo" class="bg-blue-50 rounded-xl shadow-inner p-3 hidden text-center text-sm text-blue-800 flex justify-between items-center">
                        <span><i class="fa-solid fa-circle-info"></i> <span id="intervalInfoText">選手ごとに「スタート」ボタンを押してください</span></span>
                        <div id="volumeIcon" class="text-blue-400"><i class="fa-solid fa-volume-high"></i></div>
                    </div>

                    <!-- Athlete List -->
                    <div id="athleteList" class="space-y-3 pb-8">
                        <!-- Athletes will be injected here via JS -->
                    </div>
                </div>

                <!-- Side Column: Ranking (Sticky on Desktop) -->
                <div class="lg:col-span-1 lg:sticky lg:top-24 order-last lg:order-none">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col max-h-[80vh]">
                        <!-- Header -->
                        <div class="p-3 bg-slate-50 border-b flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <i class="fa-solid fa-list-ol text-blue-600"></i> 順位表 (タイム順)
                            </h3>
                        </div>
                        
                        <!-- List -->
                        <div id="rankingListArea" class="flex-grow overflow-y-auto bg-slate-50 min-h-[200px] lg:min-h-0">
                            <div class="p-6 text-center text-slate-400 text-sm">
                                まだゴールした選手はいません
                            </div>
                        </div>

                        <!-- Footer Action -->
                        <div class="p-3 border-t bg-white shrink-0 space-y-2">
                            <button onclick="downloadCSV()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-green-700 active:scale-95 transition shadow flex items-center justify-center gap-2">
                                <i class="fa-solid fa-file-csv"></i> 成績表CSV出力
                            </button>
                            <button onclick="copyResults()" class="w-full bg-slate-700 text-white py-2 rounded-lg font-bold text-xs hover:bg-slate-800 active:scale-95 transition shadow flex items-center justify-center gap-2">
                                <i class="fa-solid fa-clipboard"></i> 簡易コピー
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Generic Modal for Confirmation -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <h3 id="modalTitle" class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <!-- Title injected via JS -->
            </h3>
            <div id="modalMessage" class="text-slate-600 mb-6 font-medium">
                <!-- Message injected via JS -->
            </div>
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal()" class="px-4 py-2 rounded-lg text-slate-600 font-bold hover:bg-slate-100 transition">
                    キャンセル
                </button>
                <button onclick="executeModalAction()" class="px-4 py-2 rounded-lg bg-orange-600 text-white font-bold hover:bg-orange-700 shadow transition flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> 実行する
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-[80] text-sm md:text-base text-center max-w-[90%]">
        <span id="toastMessage">通知</span>
    </div>

    <script>
        // --- State Management ---
        let athletes = [];
        let raceMode = 'mass'; 
        let intervalSeconds = 0; // 0 means manual
        let startSequenceBaseTime = null; 
        let raceName = ''; // Added
        let raceTitle = '';
        let raceDate = '';
        let masterStartTime = null;
        let masterFinishTime = null; 
        let timerInterval = null;
        let isRaceActive = false;
        
        let pendingModalAction = null; // Store function to execute on modal confirm

        let audioCtx = null;
        let lastBeepTime = -1;

        // --- Default Data ---
        const generateDefaults = (count) => {
             return Array.from({length: count}, (_, i) => `${i + 1}. 選手${String.fromCharCode(65 + (i % 26))}${i >= 26 ? Math.floor(i/26) : ''}`);
        };

        // --- Initialization ---
        window.onload = () => {
            const savedInput = document.getElementById('athleteInput').value;
            if(!savedInput) {
                document.getElementById('athleteInput').value = generateDefaults(10).join('\n');
            }
            document.getElementById('raceDate').valueAsDate = new Date();
            updateAthleteCount();
        };

        // --- UI Helpers ---
        function toggleIntervalSettings(show) {
            const el = document.getElementById('intervalSettings');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function updateAthleteCount() {
            const input = document.getElementById('athleteInput').value;
            const lines = input.split('\n').filter(line => line.trim() !== '');
            const badge = document.getElementById('athleteCountBadge');
            badge.innerText = `現在: ${lines.length}名`;
            
            if(lines.length > 20) {
                badge.className = "text-xs font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full";
                badge.innerText += " (多め)";
            } else {
                badge.className = "text-xs font-bold bg-blue-100 text-blue-800 px-2 py-1 rounded-full";
            }
        }

        // --- Modal Logic (Generic) ---
        function showModal(title, htmlMessage, action) {
            document.getElementById('modalTitle').innerHTML = `<i class="fa-solid fa-triangle-exclamation text-orange-500"></i> ${title}`;
            document.getElementById('modalMessage').innerHTML = htmlMessage;
            pendingModalAction = action;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            pendingModalAction = null;
        }

        function executeModalAction() {
            if(pendingModalAction) pendingModalAction();
            closeModal();
        }

        // --- List Generation Logic ---
        function requestListGeneration() {
            const count = parseInt(document.getElementById('quickCountInput').value) || 10;
            if(count < 1) return;

            showModal(
                "リスト再作成",
                `現在のリストを消去し、${count}名分の枠を作成しますか？<br><span class='text-xs text-slate-400 font-normal mt-2 block'>※現在の入力内容は失われます</span>`,
                () => {
                    const newList = generateDefaults(count);
                    document.getElementById('athleteInput').value = newList.join('\n');
                    updateAthleteCount();
                }
            );
        }

        // --- Restart Logic ---
        function requestRestart() {
            showModal(
                "確認",
                "タイムをリセットして、選手設定画面に戻りますか？<br><span class='text-xs text-slate-400 font-normal mt-2 block'>（入力した選手名は保持されます）</span>",
                performRestart
            );
        }

        function performRestart() {
            document.getElementById('raceScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
            
            athletes = [];
            masterStartTime = null;
            masterFinishTime = null;
            isRaceActive = false;
            startSequenceBaseTime = null;
            if(timerInterval) clearInterval(timerInterval);
            
            updateAthleteCount();
        }

        // --- Audio Logic ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(AudioContext) {
                    audioCtx = new AudioContext();
                }
            }
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playBeep(type) {
            if (!audioCtx) return;
            
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'go') {
                oscillator.frequency.value = 880; 
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } else {
                oscillator.frequency.value = 440; 
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            }
        }

        // --- Setup Logic ---
        function startRaceSetup() {
            initAudio();

            const input = document.getElementById('athleteInput').value;
            const lines = input.split('\n').filter(line => line.trim() !== '');
            
            raceName = document.getElementById('raceName').value || 'クロスカントリースキー大会';
            raceTitle = document.getElementById('raceTitle').value || '種目未設定';
            raceDate = document.getElementById('raceDate').value || new Date().toISOString().split('T')[0];

            if (lines.length === 0) {
                showToast("選手名を入力してください", "bg-red-600");
                return;
            }

            athletes = lines.map((name, index) => ({
                id: index + 1,
                name: name.trim(),
                status: 'ready',
                startTime: null,
                finishTime: null,
                duration: 0,
                laps: [] 
            }));

            const radios = document.getElementsByName('raceMode');
            for (const radio of radios) {
                if (radio.checked) {
                    raceMode = radio.value;
                    break;
                }
            }
            
            intervalSeconds = 0;
            if (raceMode === 'interval') {
                intervalSeconds = parseInt(document.getElementById('intervalSeconds').value) || 0;
            }

            startSequenceBaseTime = null;
            lastBeepTime = -1;

            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('raceScreen').classList.remove('hidden');

            document.getElementById('massStartControl').classList.add('hidden');
            document.getElementById('intervalInfo').classList.add('hidden');
            
            const masterBtn = document.getElementById('masterStartBtn');
            masterBtn.innerHTML = '<i class="fa-solid fa-play"></i> 全員スタート';
            masterBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 md:px-6 rounded-lg shadow-md transition transform active:scale-95 text-sm md:text-base whitespace-nowrap";
            masterBtn.onclick = triggerMassStart;
            masterStartTime = null;
            masterFinishTime = null; 

            if (raceMode === 'mass') {
                document.getElementById('massStartControl').classList.remove('hidden');
            } else {
                document.getElementById('intervalInfo').classList.remove('hidden');
                if (intervalSeconds > 0) {
                    document.getElementById('intervalInfoText').innerText = `${intervalSeconds}秒間隔スタートモード (1人目から自動)`;
                } else {
                    document.getElementById('intervalInfoText').innerText = "選手ごとに「スタート」ボタンを押してください";
                }
            }

            renderAthletes();
            refreshRanking(); 
            
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateUI, 31);
        }

        // --- Rendering ---
        function renderAthletes() {
            const list = document.getElementById('athleteList');
            list.innerHTML = '';

            athletes.forEach((athlete, index) => {
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow p-3 md:p-4 flex items-center justify-between border-l-4 transition-colors duration-200 ${getStatusColor(athlete.status)}`;
                card.id = `card-${athlete.id}`;

                let buttonHtml = '';
                let timeDisplayHtml = '';
                let lapInfoHtml = '';

                if (athlete.status === 'finished') {
                    timeDisplayHtml = `<span class="font-mono text-xl md:text-2xl font-bold text-slate-800">${formatTime(athlete.duration)}</span>`;
                } else if (athlete.status === 'running') {
                    timeDisplayHtml = `<span class="font-mono text-xl md:text-2xl font-bold text-blue-600 live-timer" id="timer-${athlete.id}" data-id="${athlete.id}">00:00.00</span>`;
                } else {
                    if (raceMode === 'interval' && intervalSeconds > 0 && startSequenceBaseTime && athlete.status === 'ready') {
                        timeDisplayHtml = `<span class="font-mono text-xl md:text-2xl font-bold text-orange-500 countdown-timer" data-index="${index}">待機中</span>`;
                    } else {
                        timeDisplayHtml = `<span class="font-mono text-xl md:text-2xl font-bold text-slate-300">--:--.--</span>`;
                    }
                }

                if (athlete.laps.length > 0) {
                    const lastLap = athlete.laps[athlete.laps.length - 1];
                    const label = lastLap.isFinal ? 'Final' : `L${athlete.laps.length}`;
                    lapInfoHtml = `<span class="text-xs font-mono text-slate-500 ml-2">(${label}: ${formatTime(lastLap.duration)})</span>`;
                }

                if (raceMode === 'mass') {
                    if (athlete.status === 'ready' || athlete.status === 'running') {
                        const isDisabled = !masterStartTime; 
                        
                        if(isDisabled) {
                             buttonHtml = `
                                <button class="btn-active w-24 h-12 rounded-lg font-bold text-white shadow bg-slate-300 cursor-not-allowed" disabled>
                                    待機
                                </button>
                            `;
                        } else {
                            buttonHtml = `
                                <div class="flex gap-2">
                                    <button onclick="athleteLap(${athlete.id})" class="btn-active w-16 md:w-20 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold shadow text-sm">
                                        ラップ
                                    </button>
                                    <button onclick="athleteFinish(${athlete.id})" class="btn-active w-16 md:w-20 h-12 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold shadow text-sm">
                                        ゴール
                                    </button>
                                </div>
                            `;
                        }
                    } else {
                        buttonHtml = `<div class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">FINISH</div>`;
                    }
                } else {
                    if (athlete.status === 'ready') {
                        let isAutoWaiting = (intervalSeconds > 0 && startSequenceBaseTime);
                        
                        if (isAutoWaiting) {
                             buttonHtml = `
                                <button onclick="athleteStart(${athlete.id})" class="btn-active w-24 h-12 bg-orange-400 hover:bg-orange-500 text-white rounded-lg font-bold shadow text-sm">
                                    強制開始
                                </button>
                            `;
                        } else {
                            buttonHtml = `
                                <button onclick="athleteStart(${athlete.id})" class="btn-active w-24 h-12 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold shadow">
                                    スタート
                                </button>
                            `;
                        }
                    } else if (athlete.status === 'running') {
                        buttonHtml = `
                            <div class="flex gap-2">
                                <button onclick="athleteLap(${athlete.id})" class="btn-active w-16 md:w-20 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold shadow text-sm">
                                    ラップ
                                </button>
                                <button onclick="athleteFinish(${athlete.id})" class="btn-active w-16 md:w-20 h-12 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold shadow text-sm animate-pulse">
                                    ゴール
                                </button>
                            </div>
                        `;
                    } else {
                        buttonHtml = `<div class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded">FINISH</div>`;
                    }
                }

                card.innerHTML = `
                    <div class="flex-grow pr-2">
                        <div class="flex items-baseline gap-2">
                            <span class="text-xs md:text-sm font-bold text-slate-400">#${athlete.id}</span>
                            <h3 class="font-bold text-base md:text-lg text-slate-800 leading-tight truncate">${athlete.name}</h3>
                        </div>
                        <div class="mt-1 flex items-baseline">
                            ${timeDisplayHtml}
                            ${lapInfoHtml}
                        </div>
                    </div>
                    <div class="">
                        ${buttonHtml}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function getStatusColor(status) {
            if (status === 'finished') return 'border-slate-500 bg-slate-50';
            if (status === 'running') return 'border-blue-500 bg-white';
            return 'border-slate-200 bg-white';
        }

        // --- Core Logic ---
        function formatTime(ms) {
            if (ms === null || ms === undefined || ms < 0) return "00:00.00";
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const centiseconds = Math.floor((ms % 1000) / 10);
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(seconds)}.${pad(centiseconds)}`;
        }

        function formatDiff(diffMs) {
            if (diffMs === 0) return "0.0";
            return "+" + formatTime(diffMs);
        }

        function triggerMassStart() {
            if (masterStartTime) return; 
            initAudio(); 
            triggerVibration();
            playBeep('go');
            masterStartTime = Date.now();
            isRaceActive = true;
            athletes.forEach(a => {
                if (a.status === 'ready') {
                    a.status = 'running';
                    a.startTime = masterStartTime;
                }
            });
            const btn = document.getElementById('masterStartBtn');
            btn.innerHTML = '<i class="fa-solid fa-flag-checkered"></i> 計測中';
            btn.className = "bg-slate-400 text-white font-bold py-3 px-6 rounded-lg shadow-inner cursor-default text-sm md:text-base";
            btn.onclick = null;
            renderAthletes();
            refreshRanking();
        }

        function athleteStart(id) {
            initAudio();
            triggerVibration();
            
            const athlete = athletes.find(a => a.id === id);
            const isFirstStart = (athletes.findIndex(a => a.status === 'running' || a.status === 'finished') === -1);

            if (athlete && athlete.status === 'ready') {
                const now = Date.now();
                athlete.startTime = now;
                athlete.status = 'running';
                
                if (raceMode === 'interval' && intervalSeconds > 0 && isFirstStart) {
                    startSequenceBaseTime = now;
                    playBeep('go'); 
                }

                renderAthletes();
                refreshRanking();
            }
        }

        function autoStartAthlete(athlete, startTime) {
            athlete.startTime = startTime;
            athlete.status = 'running';
            renderAthletes(); 
            refreshRanking();
        }

        function athleteLap(id) {
            triggerVibration();
            const now = Date.now();
            const athlete = athletes.find(a => a.id === id);
            
            if (athlete && athlete.status === 'running') {
                let lastTime = athlete.startTime;
                if (athlete.laps.length > 0) {
                    lastTime = athlete.laps[athlete.laps.length - 1].timestamp;
                }
                const lapDuration = now - lastTime;
                
                athlete.laps.push({
                    timestamp: now,
                    duration: lapDuration,
                    isFinal: false
                });

                renderAthletes();
                refreshRanking();
            }
        }

        function athleteFinish(id) {
            triggerVibration();
            const now = Date.now();
            const athlete = athletes.find(a => a.id === id);
            
            if (athlete && athlete.status === 'running') {
                athlete.finishTime = now;
                athlete.duration = now - athlete.startTime;
                athlete.status = 'finished';

                let lastTime = athlete.startTime;
                if (athlete.laps.length > 0) {
                    lastTime = athlete.laps[athlete.laps.length - 1].timestamp;
                }
                const finalLapDuration = now - lastTime;

                athlete.laps.push({
                    timestamp: now,
                    duration: finalLapDuration,
                    isFinal: true
                });
                
                renderAthletes();
                refreshRanking();

                if (athletes.every(a => a.status === 'finished')) {
                    finishRace();
                }
            }
        }

        function finishRace() {
            masterFinishTime = Date.now();
            const btn = document.getElementById('masterStartBtn');
            if (btn) {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> 全員ゴール';
                btn.className = "bg-slate-800 text-white font-bold py-3 px-6 rounded-lg shadow-inner cursor-default text-sm md:text-base";
            }
        }

        // --- UI Update Loop ---
        function updateUI() {
            const now = Date.now();

            if (raceMode === 'mass') {
                const clockEl = document.getElementById('masterClock');
                if (masterFinishTime) {
                    clockEl.innerText = formatTime(masterFinishTime - masterStartTime);
                } else if (masterStartTime) {
                    clockEl.innerText = formatTime(now - masterStartTime);
                } else {
                    clockEl.innerText = "00:00.00";
                }
            }

            if (raceMode === 'interval' && intervalSeconds > 0 && startSequenceBaseTime) {
                athletes.forEach((a, index) => {
                    if (a.status === 'ready') {
                        const targetTime = startSequenceBaseTime + (index * intervalSeconds * 1000);
                        const diff = targetTime - now;

                        const countdownEl = document.querySelector(`.countdown-timer[data-index="${index}"]`);
                        if (countdownEl) {
                             if (diff > 0) {
                                 const sec = Math.ceil(diff / 1000);
                                 countdownEl.innerText = `あと ${sec}秒`;
                                 
                                 if(sec <= 5) countdownEl.classList.add('text-red-600');
                                 else countdownEl.classList.remove('text-red-600');
                             } else {
                                 countdownEl.innerText = "スタート！";
                             }
                        }

                        const secondsRemaining = Math.ceil(diff / 1000);
                        if (secondsRemaining <= 5 && secondsRemaining > 0) {
                            const currentTimeInt = Math.floor(now / 1000);
                            if (currentTimeInt > lastBeepTime) {
                                playBeep('count');
                                lastBeepTime = currentTimeInt;
                            }
                        }

                        if (diff <= 0) {
                            playBeep('go');
                            autoStartAthlete(a, targetTime); 
                            lastBeepTime = Math.floor(now / 1000); 
                        }
                    }
                });
            }

            const liveTimers = document.querySelectorAll('.live-timer');
            liveTimers.forEach(el => {
                const id = parseInt(el.getAttribute('data-id'));
                const athlete = athletes.find(a => a.id === id);
                if (athlete && athlete.status === 'running' && athlete.startTime) {
                    el.innerText = formatTime(now - athlete.startTime);
                }
            });
        }

        // --- Utilities ---
        function triggerVibration() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function getSortedAthletes() {
            return [...athletes].sort((a, b) => {
                if (a.status === 'finished' && b.status === 'finished') return a.duration - b.duration;
                if (a.status === 'finished') return -1;
                if (b.status === 'finished') return 1;
                return a.id - b.id;
            });
        }

        function refreshRanking() {
            const sorted = getSortedAthletes();
            const container = document.getElementById('rankingListArea');
            container.innerHTML = '';

            const finishedAthletes = sorted.filter(a => a.status === 'finished');

            if(finishedAthletes.length === 0 && sorted.every(a => a.status === 'ready')) {
                 container.innerHTML = '<div class="p-6 text-center text-slate-400 text-sm">レース待機中</div>';
                 return;
            }

            const list = document.createElement('div');
            list.className = "divide-y divide-slate-200";

            const topTime = finishedAthletes.length > 0 ? finishedAthletes[0].duration : 0;

            sorted.forEach((athlete, index) => {
                const isFinished = athlete.status === 'finished';
                
                let rankDisp = '-';
                let diffDisp = '-';
                
                if(isFinished) {
                    const finishIndex = finishedAthletes.indexOf(athlete);
                    rankDisp = finishIndex + 1;
                    
                    if(finishIndex === 0) {
                        diffDisp = '0.0';
                    } else {
                        diffDisp = formatDiff(athlete.duration - topTime);
                    }
                }

                let timeText = '未出走';
                let timeClass = 'text-slate-400';
                
                if (isFinished) {
                    timeText = formatTime(athlete.duration);
                    timeClass = 'text-slate-800 font-bold';
                } else if (athlete.status === 'running') {
                    timeText = '走行中';
                    timeClass = 'text-blue-500 font-medium animate-pulse';
                }

                let rankBadge = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 font-bold text-xs">${rankDisp}</span>`;
                if(isFinished) {
                    if(rankDisp === 1) rankBadge = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-yellow-100 text-yellow-700 font-bold text-xs">1</span>`;
                    else if(rankDisp === 2) rankBadge = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-gray-200 text-slate-700 font-bold text-xs">2</span>`;
                    else if(rankDisp === 3) rankBadge = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-orange-100 text-orange-700 font-bold text-xs">3</span>`;
                    else rankBadge = `<span class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-100 text-slate-600 font-bold text-xs">${rankDisp}</span>`;
                }

                let lapsStr = '';
                if(athlete.laps.length > 0) {
                    lapsStr = athlete.laps.map((l, i) => {
                        const label = l.isFinal ? 'Final' : `L${i+1}`;
                        return `${label}:${formatTime(l.duration)}`;
                    }).join(' | ');
                }

                const row = document.createElement('div');
                row.className = `p-3 ${isFinished ? 'bg-white' : 'bg-slate-50'}`;
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="shrink-0">
                            ${rankBadge}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="text-sm font-bold text-slate-800 truncate">${athlete.name}</div>
                            ${isFinished ? `<div class="text-[10px] text-slate-500">トップ差: <span class="font-mono">${diffDisp}</span></div>` : ''}
                        </div>
                        <div class="shrink-0 text-right font-mono text-sm ${timeClass}">
                            ${timeText}
                        </div>
                    </div>
                    ${lapsStr ? `<div class="mt-1 ml-9 text-[10px] text-slate-500 font-mono truncate">${lapsStr}</div>` : ''}
                `;
                list.appendChild(row);
            });

            container.appendChild(list);
        }

        function downloadCSV() {
            const sortedAthletes = getSortedAthletes();
            const finishedAthletes = sortedAthletes.filter(a => a.status === 'finished');
            const topTime = finishedAthletes.length > 0 ? finishedAthletes[0].duration : 0;
            
            let csvContent = `大会名,${raceName}\n種目名,${raceTitle}\n開催日,${raceDate}\n\n`;
            csvContent += "順位,Bib,名前,フィニッシュタイム,時間差,備考\n";

            let finishedCount = 0;
            sortedAthletes.forEach((a) => {
                if(a.status !== 'finished') return; 
                
                finishedCount++;
                const rank = finishedCount;
                const timeStr = formatTime(a.duration);
                let diffStr = '0.0';
                
                if (rank > 1) {
                    diffStr = "+" + formatTime(a.duration - topTime);
                }

                let lapInfo = "";
                if(a.laps.length > 0) {
                    lapInfo = a.laps.map((l, i) => {
                        const label = l.isFinal ? 'Final' : `L${i+1}`;
                        return `${label}:${formatTime(l.duration)}`;
                    }).join(' | ');
                }

                csvContent += `${rank},${a.id},${a.name},${timeStr},${diffStr},${lapInfo}\n`;
            });

            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `result_${raceDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyResults() {
            const sortedAthletes = getSortedAthletes();
            let text = "【大会結果】\n";
            let finishedCount = 0;
            
            sortedAthletes.forEach((a) => {
                let timeStr = '';
                let rankStr = '-';
                let lapStr = '';
                
                if(a.status === 'finished') {
                    finishedCount++;
                    timeStr = formatTime(a.duration);
                    rankStr = `${finishedCount}位`;
                } else if (a.status === 'running') {
                    timeStr = '走行中';
                } else {
                    timeStr = '未出走';
                }

                if(a.laps.length > 0) {
                    const laps = a.laps.map((l, i) => {
                        const label = l.isFinal ? 'Final' : `L${i+1}`;
                        return `${label}: ${formatTime(l.duration)}`;
                    }).join(', ');
                    lapStr = ` [${laps}]`;
                }
                
                text += `${rankStr} ${timeStr} ${a.name}${lapStr}\n`;
            });

            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    showToast("結果をクリップボードに<br class='md:hidden'>コピーしました");
                } else {
                    showToast("コピーに失敗しました", "bg-red-600");
                }
            } catch (err) {
                console.error('Copy failed', err);
                showToast("コピーに失敗しました", "bg-red-600");
            }
            
            document.body.removeChild(textArea);
        }

        function showToast(message, bgClass = "bg-slate-800") {
            const toast = document.getElementById('toast');
            const msgSpan = document.getElementById('toastMessage');
            
            msgSpan.innerHTML = message;
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-xl transition-opacity duration-300 pointer-events-none z-[80] text-sm md:text-base text-center max-w-[90%] ${bgClass}`;
            
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }
    </script>
</body>
</html>
